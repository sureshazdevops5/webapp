# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- none

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'docker-spn'
  imageRepository: 'webapplication'
  containerRegistry: 'testsureshacr.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  # Agent VM image name
  vmImageName: 'ubuntu-latest'


pool:
 vmImage: $(vmImageName)

steps:

- task: UseDotNet@2
  displayName: dotnetsdk

- task: NuGetToolInstaller@1
  displayName: nuget-install

- task: NuGetCommand@2
  displayName: nuget-restore
  inputs:
     command: restore
     restoreSolution: $(solution)
  

- task: DotNetCoreCLI@2
  displayName: Build
  inputs:
   command: build
   projects: '**/*.csproj'
   arguments: '--configuration $(buildConfiguration)'

- task: DotNetCoreCLI@2
  displayName: publish
  inputs:
   command: publish
   publishWebProjects: true
   zipAfterPublish: false
   arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
- task: PublishBuildArtifacts@1
  displayName: publish artifact
  inputs:
     ArtifactName: webapp
     publishLocation: Container
     PathtoPublish: '$(Build.ArtifactStagingDirectory)/webapp'


- script: ls -R $(Build.ArtifactStagingDirectory)


- task: Docker@2
  displayName: Build and push an image to container registry
  inputs: 
     command: buildAndPush
     buildContext: '$(Build.ArtifactStagingDirectory)/webapp'
     repository: $(imageRepository)
     dockerfile: $(dockerfilePath)
     containerRegistry: $(dockerRegistryServiceConnection)
     tags: |
       $(tag)

- task: ShellScript@2
  displayName: update manifest
  inputs:
     scriptPath: 'WebApp/manifest.sh'
     args: webapp80 $(imageRepository) $(tag)

